<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高级音频循环播放器</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }
        .container {
            text-align: center;
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        button, input, select {
            margin: 10px;
            padding: 5px 10px;
            font-size: 16px;
        }
        #waveform {
            width: 100%;
            height: 100px;
            background-color: #eee;
        }
        #progressBar {
            width: 100%;
            height: 20px;
            background-color: #ddd;
            margin-top: 10px;
        }
        #progress {
            width: 0%;
            height: 100%;
            background-color: #4CAF50;
        }
        #fileUpload {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>高级音频循环播放器</h1>
        <canvas id="waveform"></canvas>
        <div id="progressBar"><div id="progress"></div></div>
        <audio id="audioPlayer"></audio>
        <div>
            <input type="file" id="fileUpload" accept="audio/*">
            <button onclick="document.getElementById('fileUpload').click()">上传音频</button>
            <span id="fileName"></span>
        </div>
        <div>
            <button onclick="playAudio()">播放</button>
            <button onclick="pauseAudio()">暂停</button>
        </div>
        <div>
            <label>循环起始时间：</label>
            <select id="startHours"></select>时
            <select id="startMinutes"></select>分
            <select id="startSeconds"></select>秒
        </div>
        <div>
            <label>循环结束时间：</label>
            <select id="endHours"></select>时
            <select id="endMinutes"></select>分
            <select id="endSeconds"></select>秒
        </div>
        <div>
            <label>循环间隔：</label>
            <select id="intervalHours"></select>时
            <select id="intervalMinutes"></select>分
            <select id="intervalSeconds"></select>秒
        </div>
        <div>
            <button onclick="startLoop()">开始循环</button>
            <button onclick="stopLoop()">停止循环</button>
        </div>
    </div>

    <script>
        const audio = document.getElementById('audioPlayer');
        const fileUpload = document.getElementById('fileUpload');
        const fileName = document.getElementById('fileName');
        const progressBar = document.getElementById('progress');
        const waveformCanvas = document.getElementById('waveform');
        const waveformCtx = waveformCanvas.getContext('2d');
        let audioContext, analyser, dataArray;
        let loopTimer;

        // 初始化时间选择下拉菜单
        function initTimeSelects() {
            const timeSelects = ['start', 'end', 'interval'];
            timeSelects.forEach(prefix => {
                const hours = document.getElementById(`${prefix}Hours`);
                const minutes = document.getElementById(`${prefix}Minutes`);
                const seconds = document.getElementById(`${prefix}Seconds`);
                
                for (let i = 0; i < 24; i++) hours.options.add(new Option(i.toString().padStart(2, '0'), i));
                for (let i = 0; i < 60; i++) {
                    minutes.options.add(new Option(i.toString().padStart(2, '0'), i));
                    seconds.options.add(new Option(i.toString().padStart(2, '0'), i));
                }
            });
        }

        initTimeSelects();

        fileUpload.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                fileName.textContent = file.name;
                audio.src = URL.createObjectURL(file);
                audio.onloadedmetadata = () => {
                    const duration = Math.floor(audio.duration);
                    const hours = Math.floor(duration / 3600);
                    const minutes = Math.floor((duration % 3600) / 60);
                    const seconds = duration % 60;
                    document.getElementById('endHours').value = hours;
                    document.getElementById('endMinutes').value = minutes;
                    document.getElementById('endSeconds').value = seconds;
                    setupAudioContext();
                };
            }
        });

        function setupAudioContext() {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            const source = audioContext.createMediaElementSource(audio);
            source.connect(analyser);
            analyser.connect(audioContext.destination);
            analyser.fftSize = 256;
            dataArray = new Uint8Array(analyser.frequencyBinCount);
            drawWaveform();
        }

        function drawWaveform() {
            requestAnimationFrame(drawWaveform);
            analyser.getByteTimeDomainData(dataArray);
            waveformCtx.fillStyle = 'rgb(200, 200, 200)';
            waveformCtx.fillRect(0, 0, waveformCanvas.width, waveformCanvas.height);
            waveformCtx.lineWidth = 2;
            waveformCtx.strokeStyle = 'rgb(0, 0, 0)';
            waveformCtx.beginPath();
            const sliceWidth = waveformCanvas.width * 1.0 / dataArray.length;
            let x = 0;
            for (let i = 0; i < dataArray.length; i++) {
                const v = dataArray[i] / 128.0;
                const y = v * waveformCanvas.height / 2;
                if (i === 0) {
                    waveformCtx.moveTo(x, y);
                } else {
                    waveformCtx.lineTo(x, y);
                }
                x += sliceWidth;
            }
            waveformCtx.lineTo(waveformCanvas.width, waveformCanvas.height / 2);
            waveformCtx.stroke();
        }

        function updateProgress() {
            const progress = (audio.currentTime / audio.duration) * 100;
            progressBar.style.width = `${progress}%`;
            requestAnimationFrame(updateProgress);
        }

        function playAudio() {
            audio.play();
            updateProgress();
        }

        function pauseAudio() {
            audio.pause();
        }

        function getTimeInSeconds(hoursId, minutesId, secondsId) {
            const hours = parseInt(document.getElementById(hoursId).value);
            const minutes = parseInt(document.getElementById(minutesId).value);
            const seconds = parseInt(document.getElementById(secondsId).value);
            return hours * 3600 + minutes * 60 + seconds;
        }

        function startLoop() {
            if (!audio.src) {
                alert('请先上传音频文件');
                return;
            }
            const startTime = getTimeInSeconds('startHours', 'startMinutes', 'startSeconds');
            const endTime = getTimeInSeconds('endHours', 'endMinutes', 'endSeconds');
            const interval = getTimeInSeconds('intervalHours', 'intervalMinutes', 'intervalSeconds') * 1000;
            
            if (startTime >= endTime) {
                alert('起始时间必须小于结束时间');
                return;
            }

            function playLoop() {
                audio.currentTime = startTime;
                audio.play();
                audio.onended = () => {
                    if (audio.currentTime >= endTime) {
                        setTimeout(playLoop, interval);
                    }
                };
            }

            playLoop();
        }

        function stopLoop() {
            pauseAudio();
            audio.onended = null;
        }

        audio.addEventListener('timeupdate', () => {
            const endTime = getTimeInSeconds('endHours', 'endMinutes', 'endSeconds');
            if (audio.currentTime >= endTime) {
                audio.pause();
            }
        });
    </script>
</body>
</html>
